#!/bin/bash

#   Author: Angela Crabtree

# This script automates the download of 20 PCam (patch camelyon 17) WSIs from an FTP server
# Each WSI zip file takes ~1hr to download. Zipped file size is 4-15 Gb. 
# Here's a great resource for how to download TCGA data: http://www.andrewjanowczyk.com/download-tcga-digital-pathology-images-ffpe/


# make folders to generally match nightingale directories & contents
mkdir -p ./data/tcga
cd ./data/tcga

# make spreadsheets 
echo "biopsy_id,patient_ngsci_id,case_year,mortality,time_to_death,stage,stage_max,metastatic_dx,time_to_metastasis
7b51c0b42-d278-46-d8-a739-7ba7,6f725556-4940-9fa20,2018,0,,I,I,0,
7b51c0b42-d278-46-d8-a739-7ba8,6f725556-4940-9fa21,2018,0,,IIA,IIA,0,
7b51c0b42-d278-46-d8-a739-7ba9,6f725556-4940-9fa22,2018,0,,IIB,IIB,0,
7b51c0b42-d278-46-d8-a739-7ba10,6f725556-4940-9fa23,2020,0,,IIB,IIB,0,
7b51c0b42-d278-46-d8-a739-7ba11,6f725556-4940-9fa24,2020,0,,IIB,IIB,0,
7b51c0b42-d278-46-d8-a739-7ba12,6f725556-4940-9fa25,2020,0,,IIIA,IIIA,0,
7b51c0b42-d278-46-d8-a739-7ba13,6f725556-4940-9fa26,2019,0,,IIIB,IIIB,0,
7b51c0b42-d278-46-d8-a739-7ba14,6f725556-4940-9fa27,2019,0,,IIIC,IIIC,0,
7b51c0b42-d278-46-d8-a739-7ba15,6f725556-4940-9fa28,2019,0,,IV,IV,1,20" > outcomes.csv

echo "slide_id,biopsy_id
TCGA-A2-A0EP-01Z-00-DX1.1180C406-5C18-4373-8621-1B7B70875113,7b51c0b42-d278-46-d8-a739-7ba7
TCGA-D8-A143-01Z-00-DX1.4697FB2F-91D5-4506-AF23-7DE304D44A3F,7b51c0b42-d278-46-d8-a739-7ba8
TCGA-LL-A442-01Z-00-DX1.9275EDBD-1C89-4AF3-B02B-19F613A4E083,7b51c0b42-d278-46-d8-a739-7ba8
TCGA-OL-A6VQ-01Z-00-DX1.E3B81163-0239-47C3-B53F-064405B58685,7b51c0b42-d278-46-d8-a739-7ba8
TCGA-AR-A0U0-01Z-00-DX1.C8BECD9F-68D9-47B1-B31E-C1C6CAE456B6,7b51c0b42-d278-46-d8-a739-7ba9
TCGA-A2-A0D4-01Z-00-DX1.35E43827-DABC-4685-A62A-333672923349,7b51c0b42-d278-46-d8-a739-7ba9
TCGA-EW-A6SD-01Z-00-DX1.32D8240E-2076-492B-BB95-300A9FCA96E7,7b51c0b42-d278-46-d8-a739-7ba9
TCGA-BH-A0B1-01Z-00-DX1.CC60D284-04FB-4B73-90AA-FCE9185DADB6,7b51c0b42-d278-46-d8-a739-7ba10
TCGA-B6-A0WV-01Z-00-DX1.A8B9E114-A8CF-4389-B47C-2E1B842F7FF9,7b51c0b42-d278-46-d8-a739-7ba10
TCGA-E2-A1IG-01Z-00-DX1.C894EEA1-708A-4043-8C60-3BCA98AA751E,7b51c0b42-d278-46-d8-a739-7ba11
TCGA-D8-A1XB-01Z-00-DX1.DA8E2FA4-DBBA-4157-8052-B90FB3BB58F1,7b51c0b42-d278-46-d8-a739-7ba11
TCGA-E2-A1L7-01Z-00-DX1.BE796CD2-2E81-44E8-8CA2-85B4D2A31B64,7b51c0b42-d278-46-d8-a739-7ba12
TCGA-GI-A2C8-01Z-00-DX1.09BD8AC9-645A-4C8B-9B36-77D833BDBA09,7b51c0b42-d278-46-d8-a739-7ba13
TCGA-A2-A0YT-01Z-00-DX1.63CA3E36-B3E4-4D3F-9F80-2703970DBE5B,7b51c0b42-d278-46-d8-a739-7ba13
TCGA-BH-A28O-01Z-00-DX1.B37603E3-BC80-4DDA-B44D-B5F794E3398E,7b51c0b42-d278-46-d8-a739-7ba14
TCGA-D8-A27R-01Z-00-DX2.31F47D8F-DFD7-42AE-BBBA-7DBBA12FA97D,7b51c0b42-d278-46-d8-a739-7ba14
TCGA-A2-A4RW-01Z-00-DX1.4AF8656E-2478-4895-8C59-B0C969F3E474,7b51c0b42-d278-46-d8-a739-7ba14
TCGA-A2-A0SV-01Z-00-DX1.F5645E47-3540-4753-AF5D-F5709BD8DFC1,7b51c0b42-d278-46-d8-a739-7ba15" > slide-biopsy-map.csv

# make manifest (originally downloaded from TGCA:
echo "id	filename	md5	size	state
0312a54c-3a16-4f85-a228-99d6efa09c1b	TCGA-BH-A28O-01Z-00-DX1.B37603E3-BC80-4DDA-B44D-B5F794E3398E.svs	e844432339747cda0f0a2c0f8efeaad5	1682929448	validated
0323e070-884a-4da1-b9ef-b8ea99a5c1de	TCGA-A2-A4RW-01Z-00-DX1.4AF8656E-2478-4895-8C59-B0C969F3E474.svs	1ad5a014724279238aff64964d22b8f7	1650923505	validated
0a886f18-c44c-4b5e-b243-6df6e27f426a	TCGA-GI-A2C8-01Z-00-DX1.09BD8AC9-645A-4C8B-9B36-77D833BDBA09.svs	a9f830d456b4a1fe0e9bb5b5b99f4b7e	408704377	validated
23e2ba74-3457-4f1a-8c12-ea00af16c49c	TCGA-A2-A0YT-01Z-00-DX1.63CA3E36-B3E4-4D3F-9F80-2703970DBE5B.svs	402a25f50563a0c426f5aa7868365267	1542549997	validated
411e68e5-a78e-486d-aba6-fdef038f9082	TCGA-LL-A442-01Z-00-DX1.9275EDBD-1C89-4AF3-B02B-19F613A4E083.svs	a0413e5384a58716a1336739e70500b8	1483915041	validated
416e4645-4ef2-4228-8e93-703d138834e4	TCGA-A2-A0SV-01Z-00-DX1.F5645E47-3540-4753-AF5D-F5709BD8DFC1.svs	0af6063ab09eecbd76ecc6896e5a8f88	1495994795	validated
41e7e8c7-bde3-4aa7-a0c9-98e039d641b5	TCGA-EW-A6SD-01Z-00-DX1.32D8240E-2076-492B-BB95-300A9FCA96E7.svs	ddfe6e0f6fd788ac4ea113ecabeeca23	1932094841	validated
4d9eabb5-9a2c-4b40-a3b6-37fa5e37b8ae	TCGA-BH-A0B1-01Z-00-DX1.CC60D284-04FB-4B73-90AA-FCE9185DADB6.svs	30ec46d6e22732164014ba50cff1408a	1254673757	validated
5ab9bb78-d1ad-430e-9603-ce88d4352a92	TCGA-B6-A0WV-01Z-00-DX1.A8B9E114-A8CF-4389-B47C-2E1B842F7FF9.svs	d280e9d7b94d3e20b5302c9af3aad0d9	1618966765	validated
632e0879-7531-427c-ac37-a0bbbcd52998	TCGA-A2-A0EP-01Z-00-DX1.1180C406-5C18-4373-8621-1B7B70875113.svs	cff54384b50a3c751f8e789fe7011bbc	627890703	validated
6f29dfa9-d166-4f07-9cdb-0daceb7341e9	TCGA-D8-A27R-01Z-00-DX2.31F47D8F-DFD7-42AE-BBBA-7DBBA12FA97D.svs	8f47d35be3f649ce444fc88774b18b33	1920382235	validated
76ab7a55-3d1e-43fe-8078-7c648f4a02bb	TCGA-AR-A0U0-01Z-00-DX1.C8BECD9F-68D9-47B1-B31E-C1C6CAE456B6.svs	875b88b766ff856dd9569c0a0b5829af	518469583	validated
966c7061-a5e0-4340-8e51-2d5dd509c663	TCGA-E2-A1L7-01Z-00-DX1.BE796CD2-2E81-44E8-8CA2-85B4D2A31B64.svs	c2e94fca66e21076d27816d0e5682bf9	354195597	validated
cc5cc070-d63d-4d50-91f9-1efb23d28034	TCGA-D8-A143-01Z-00-DX1.4697FB2F-91D5-4506-AF23-7DE304D44A3F.svs	f8687a3985fde2b26ffb2d49785b8c49	1169925813	validated
d813038d-b9e8-4af6-9578-626436be5d84	TCGA-E2-A1IG-01Z-00-DX1.C894EEA1-708A-4043-8C60-3BCA98AA751E.svs	850c86523f683eca0c72d310aefe5c1b	1694914299	validated
d8a5a25e-f7dc-4c0d-8d08-efa050713725	TCGA-OL-A6VQ-01Z-00-DX1.E3B81163-0239-47C3-B53F-064405B58685.svs	5c925c730304fcdd3c969bb70f1eccef	1743816509	validated
f41ab201-fff7-4806-9597-656953d3d338	TCGA-A2-A0D4-01Z-00-DX1.35E43827-DABC-4685-A62A-333672923349.svs	88e11dc560fc789059a1338a99c00b07	960980821	validated
f4ee6dd7-36d6-45b1-aac5-8b0f44ba3bf7	TCGA-D8-A1XB-01Z-00-DX1.DA8E2FA4-DBBA-4157-8052-B90FB3BB58F1.svs	c6be618ef0cbc1e7d922f13125f250a8	1546387721	validated" > gdc_manifest_20220628_171343.txt

# download TGCA downloading app
wget https://gdc.cancer.gov/files/public/file/gdc-client_v1.6.1_Ubuntu_x64.zip
unzip gdc-client_v1.6.1_Ubuntu_x64.zip
rm gdc-client_v1.6.1_Ubuntu_x64.zip
chmod a+x gdc-client

# download WSIs (will take approximately 10-30 seconds per image)
./gdc-client download -m ./gdc_manifest_20220628_171343.txt

# extract .svs files from each folder
for file in */*.svs; do mv ${file} .; done
cd ../..